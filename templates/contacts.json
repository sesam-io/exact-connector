[
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-collect",
    "namespaced_identifiers": false,
    "source": {
      "id_expression": "{{ {{@ id_name @}} }}",
      "operation": "list",
      "properties": {
        "datatype": "{{@ endpoint @}}",
        "endpoint_type": "{{@ endpoint_type @}}"
      },
      "system": "{{@ system @}}",
      "type": "rest"
    },
    "transform": {
      "rules": {
        "default": [
          [
            "copy",
            "*"
          ],
          [
            "merge",
            [
              "apply",
              "format-date",
              [
                "dict",
                [
                  "list",
                  [
                    "list",
                    "OrderDate",
                    "_T.OrderDate"
                  ],
                  [
                    "list",
                    "Modified",
                    "_T.Modified"
                  ],
                  [
                    "list",
                    "InvoiceDate",
                    "_T.InvoiceDate"
                  ],
                  [
                    "list",
                    "DueDate",
                    "_T.DueDate"
                  ],
                  [
                    "list",
                    "Created",
                    "_T.Created"
                  ],
                  [
                    "list",
                    "StartDate",
                    "_T.StartDate"
                  ],
                  [
                    "list",
                    "CustomerSince",
                    "_T.CustomerSince"
                  ],
                  [
                    "list",
                    "StatusSince",
                    "_T.StatusSince"
                  ],
                  [
                    "list",
                    "EndDate",
                    "_T.EndDate"
                  ]
                ]
              ]
            ]
          ],
          [
            "add",
            "$last_modified",
            "_T.Modified"
          ]
        ],
        "format-date": [
          [
            "add",
            "_temp_date",
            [
              "key-values",
              "_S."
            ]
          ],
          [
            "merge",
            [
              "map",
              [
                "if",
                [
                  "and",
                  [
                    "neq",
                    "_.value",
                    null
                  ],
                  [
                    "eq",
                    [
                      "has-key",
                      "_.key",
                      "_P."
                    ],
                    false
                  ]
                ],
                [
                  "dict",
                  "_.key",
                  [
                    "datetime",
                    [
                      "integer",
                      [
                        "multiply",
                        [
                          "integer",
                          [
                            "replace",
                            {
                              ")/": "",
                              "/Date(": ""
                            },
                            "_.value"
                          ]
                        ],
                        1000000
                      ]
                    ]
                  ]
                ]
              ],
              "_T._temp_date"
            ]
          ]
        ]
      },
      "type": "dtl"
    },
    "type": "pipe"
  },
  {
    "_id": "{{@ system @}}-{{@ datatype @}}-share",
    "add_namespaces": false,
    "batch_size": 1,
    "compaction": {
      "keep_versions": 100
    },
    "exclude_completeness": [
      "{{@ system @}}-{{@ datatype @}}-share"
    ],
    "namespaced_identifiers": false,
    "sink": {
      "deletion_tracking": false,
      "set_initial_offset": "onload"
    },
    "source": {
      "dataset": "{{@ system @}}-{{@ datatype @}}-transform",
      "type": "dataset"
    },
    "transform": {
      "properties": {
        "id_expression": "{{ {{@ id_name @}} }}",
        "operation_delete_properties": {
          "datatype": "{{@ endpoint @}}",
          "endpoint_type": "{{@ endpoint_type @}}",
          "id_name": "{{@ id_name @}}"
        },
        "operation_insert_properties": {
          "datatype": "{{@ endpoint @}}",
          "endpoint_type": "{{@ endpoint_type @}}"
        },
        "operation_lookup_properties": {
          "datatype": "{{@ endpoint @}}",
          "endpoint_type": "{{@ endpoint_type @}}",
          "id_name": "{{@ id_name @}}"
        },
        "operation_update_properties": {
          "datatype": "{{@ endpoint @}}",
          "endpoint_type": "{{@ endpoint_type @}}",
          "id_name": "{{@ id_name @}}"
        },
        "primary_key": "{{@ id_name @}}",
        "rest_system": "{{@ system @}}",
        "share_dataset": "{{@ system @}}-{{@ datatype @}}-share"
      },
      "template": "transform-share-rest",
      "type": "template"
    },
    "type": "pipe"
  }
]